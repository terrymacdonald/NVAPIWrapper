<Project Sdk="Microsoft.NET.Sdk">
	<PropertyGroup>
		<TargetFramework>net10.0</TargetFramework>
		<LangVersion>12.0</LangVersion>
		<Nullable>enable</Nullable>
		<AllowUnsafeBlocks>true</AllowUnsafeBlocks>
		<RootNamespace>NVAPIWrapper</RootNamespace>
		<AssemblyName>NVAPIWrapper</AssemblyName>
		<GenerateAssemblyInfo>true</GenerateAssemblyInfo>
		<ClangSharpGeneratedDir>$(MSBuildProjectDirectory)\cs_generated</ClangSharpGeneratedDir>

		<Description>A modern C# wrapper for NVIDIA's NVAPI using ClangSharp</Description>
		<Platforms>AnyCPU;x64</Platforms>
		<GenerateDocumentationFile>true</GenerateDocumentationFile>
		<DocumentationFile>$(OutputPath)$(AssemblyName).xml</DocumentationFile>
		<NoWarn>$(NoWarn);1591;1589</NoWarn>
	</PropertyGroup>

	<ItemGroup>
		<PackageReference Include="ClangSharp" Version="20.1.2" PrivateAssets="all" />
		<PackageReference Include="ClangSharp.Interop" Version="20.1.2" PrivateAssets="all" />
		<PackageReference Include="ClangSharp.PInvokeGenerator" Version="20.1.2" PrivateAssets="all" />
	</ItemGroup>

	<ItemGroup>
		<ClangSharpPInvokeGenerator Include="ClangSharpConfig.rsp" />
	</ItemGroup>

	<!-- Avoid double-including generated files when they already exist at evaluation time -->
	<ItemGroup>
		<Compile Remove="cs_generated\**\*.cs" />
	</ItemGroup>

	<Target Name="CleanClangSharpGenerated" AfterTargets="Clean">
		<Message Text="Removing ClangSharp generated directory $(ClangSharpGeneratedDir)... " Importance="high" />
		<RemoveDir Directories="$(ClangSharpGeneratedDir)" Condition="Exists('$(ClangSharpGeneratedDir)')" />
		<Delete Files="$(BaseIntermediateOutputPath)ClangSharp.stamp" Condition="Exists('$(BaseIntermediateOutputPath)ClangSharp.stamp')" />
	</Target>

	<Target Name="SetVersionFromGit" BeforeTargets="GetAssemblyVersion;GenerateAssemblyInfo;BeforeBuild;BeforeRebuild;CoreCompile">
		<PropertyGroup>
			<VersionFile>$(MSBuildProjectDirectory)\..\VERSION</VersionFile>
		</PropertyGroup>

		<ReadLinesFromFile File="$(VersionFile)" Condition="Exists('$(VersionFile)')">
			<Output TaskParameter="Lines" ItemName="VersionFileLines" />
		</ReadLinesFromFile>

		<ItemGroup>
			<MajorLine Include="@(VersionFileLines)" Condition="$([System.String]::new('%(Identity)').Trim().StartsWith('MAJOR='))" />
			<MinorLine Include="@(VersionFileLines)" Condition="$([System.String]::new('%(Identity)').Trim().StartsWith('MINOR='))" />
		</ItemGroup>

		<PropertyGroup>
			<_RawMajor>@(MajorLine)</_RawMajor>
			<_RawMinor>@(MinorLine)</_RawMinor>

			<VersionMajor>$([System.String]::new('$(_RawMajor)').Replace('MAJOR=', '').Trim())</VersionMajor>
			<VersionMinor>$([System.String]::new('$(_RawMinor)').Replace('MINOR=', '').Trim())</VersionMinor>
			<VersionMajor Condition="'$(VersionMajor)' == ''">1</VersionMajor>
			<VersionMinor Condition="'$(VersionMinor)' == ''">0</VersionMinor>
		</PropertyGroup>

		<PropertyGroup>
			<SolutionRoot>$(MSBuildProjectDirectory)\..</SolutionRoot>
		</PropertyGroup>

		<Exec Command="git log -n 1 --format=%%H -- VERSION" ConsoleToMSBuild="true" IgnoreExitCode="true" WorkingDirectory="$(SolutionRoot)" StandardOutputImportance="low">
			<Output TaskParameter="ConsoleOutput" PropertyName="LastVersionChangeHash" />
			<Output TaskParameter="ExitCode" PropertyName="GitLogExitCode" />
		</Exec>

		<PropertyGroup>
			<FinalHash Condition="'$(GitLogExitCode)' == '0'">$(LastVersionChangeHash)</FinalHash>

			<GitCountCommand Condition="'$(FinalHash)' != ''">git rev-list --count $(FinalHash)..HEAD</GitCountCommand>
			<GitCountCommand Condition="'$(FinalHash)' == ''">git rev-list --count HEAD</GitCountCommand>
		</PropertyGroup>

		<Exec Command="$(GitCountCommand)" ConsoleToMSBuild="true" IgnoreExitCode="true" WorkingDirectory="$(SolutionRoot)" StandardOutputImportance="low">
			<Output TaskParameter="ConsoleOutput" PropertyName="GitCommitCount" />
			<Output TaskParameter="ExitCode" PropertyName="GitCountExitCode" />
		</Exec>

		<PropertyGroup>
			<VersionPatch Condition="'$(GitCountExitCode)' == '0' AND '$(GitCommitCount)' != ''">$(GitCommitCount)</VersionPatch>
			<VersionPatch Condition="'$(VersionPatch)' == ''">0</VersionPatch>

			<AppVersion>$(VersionMajor).$(VersionMinor).$(VersionPatch)</AppVersion>

			<Version>$(AppVersion)</Version>
			<AssemblyVersion>$(AppVersion)</AssemblyVersion>
			<FileVersion>$(AppVersion)</FileVersion>
			<InformationalVersion>$(AppVersion)</InformationalVersion>
		</PropertyGroup>

		<Message Text="-&gt; NVAPIWrapper Version: $(AppVersion) (Major/Minor from file, Patch is commits since change)" Importance="high" />
	</Target>

	<Target Name="GenerateFromClangSharp" BeforeTargets="CoreCompile" Inputs="@(ClangSharpPInvokeGenerator)" Outputs="$(BaseIntermediateOutputPath)ClangSharp.stamp">
		<Exec Command="ClangSharpPInvokeGenerator %40&quot;@(ClangSharpPInvokeGenerator)&quot;" />
		<ItemGroup>
			<Compile Include="$(ClangSharpGeneratedDir)\**\*.cs" />
		</ItemGroup>
		<ItemGroup>
			<FileWrites Include="$(ClangSharpGeneratedDir)\**\*" />
			<FileWrites Include="$(BaseIntermediateOutputPath)ClangSharp.stamp" />
		</ItemGroup>
		<Touch Files="$(BaseIntermediateOutputPath)ClangSharp.stamp" AlwaysCreate="true" />
	</Target>

</Project>
